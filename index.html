<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ“ãƒ‡ã‚ªè¨ºå¯Ÿã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ“ãƒ‡ã‚ªé›»è©±éƒ¨åˆ† -->
        <div class="left-side">
            <h1>ğŸ¥Doctorã¨ãƒ“ãƒ‡ã‚ªãƒãƒ£ãƒƒãƒˆğŸ¥</h1>
        <!-- ä»¥ä¸‹ãŒãƒ“ãƒ‡ã‚ªç”¨ã®ã‚³ãƒ¼ãƒ‰ -->
            <div class="grid-container">
                <div id="local" class="item">
                 <video id="local-video" autoplay playsinline></video>
                 <audio id="local-audio" autoplay muted controls></audio>
                 <p class="id-text">ID: <span id="my-id"></span></p>
                 <button id="join-button" class="item" label="button">Roomä½œæˆ/å‚åŠ </button>
                 <input id="room-name" placeholder="Roomå"></input>
                 <button id="local-mute-buton" class="item" label="button" disabled>æ˜ åƒãƒ»éŸ³å£°OFF</button>
                 <button id="leave-button" class="item" label="button"ã€€disabled>Roomé–‰ã˜ã‚‹</button>
               </div>
               <div id="remote" class="item">
                 <video id="remote-video" autoplay playsinline></video>
                 <audio id="remote-audio" autoplay controls></audio>
                 <p class="id-text">ID: <span id="remote-id"></span></p>
                 <div id="button-area"></div>
               </div>
             </div>
        <!-- ä»¥ä¸ŠãŒãƒ“ãƒ‡ã‚ªç”¨ã®ã‚³ãƒ¼ãƒ‰ -->
         <!-- ä»¥ä¸‹ï¼‘è¡ŒãŒvideoç”¨ã®ã‚³ãƒ¼ãƒ‰ -->
            <!-- <video id="remote-video" autoplay playsinline></video> -->
        </div>

        <div class="right-side">
            <div id="subtitles" class="subtitles-box">
                <!-- å­—å¹•ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>

            <div id="question-box" class="input-box">
                <input type="text" id="question-input" placeholder="è³ªå•ã‚’å…¥åŠ›">
                <button id="send-question">é€ä¿¡</button>
                <button id="delete-answer">å›ç­”å‰Šé™¤</button> <!-- å›ç­”å‰Šé™¤ãƒœã‚¿ãƒ³ -->
            </div>

            <div id="response" class="response-box">
                <!-- AIã®å›ç­”ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>

            <div id="subtitle-buttons" class="subtitle-buttons">
                <button id="hide-subtitles">å­—å¹•éè¡¨ç¤º</button>
                <button id="show-subtitles">å­—å¹•è¡¨ç¤º</button>
                <button id="clear-subtitles">å­—å¹•å‰Šé™¤</button> <!-- å­—å¹•å‰Šé™¤ãƒœã‚¿ãƒ³ -->
            </div>

        </div>

    </div>
    <!-- jQueryã®èª­ã¿è¾¼ã¿ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- SkyWayã®SDKã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/@skyway-sdk/room@latest/skyway_room-latest.js"></script>    
    <!-- Firebase App (firebase-app.js) ã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
    
    // Firebase SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded } 
        from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js"; /*è¿½åŠ ãŒå¿…è¦*/
     // TODO: Add SDKs for Firebase products that you want to use
     // https://firebase.google.com/docs/web/setup#available-libraries

    
    const firebaseConfig = {
    apiKey: "::::::::::::::::::",
    authDomain: "::::::::::::::::",
    databaseURL: ":::::::::::::::::",
    projectId: "::::::::::::",
    storageBucket: "::::::::::::::",
    messagingSenderId: ":::::::::::::",
    appId: ":::::::::::::::::::::"
  };

    // Firebaseã®åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const questionsRef = ref(db, 'questions');

// ä»¥ä¸‹ãŒãƒ´ã‚£ãƒ‡ã‚ªç”¨ã®ã“ãƒ¼ã©
   
// const { nowInSec, SkyWayAuthToken, SkyWayContext, SkyWayRoom, SkyWayStreamFactory, uuidV4 } = skyway_room;

// // STEP1: SkyWayAuthTokenã®ç”Ÿæˆ
// const appId = '::::::::::::::::::::'
// const secretKey = ':::::::::::::::::::'
// const token = new SkyWayAuthToken({
//     jti: uuidV4(),
//     iat: nowInSec(),
//     exp: nowInSec() + 60 * 60 * 24,
//     scope: {
//       app: {
//         id: appId,
//         turn: true,
//         actions: ['read'],
//         channels: [
//           {
//             id: '*',
//             name: '*',
//             actions: ['write'],
//             members: [
//               {
//                 id: '*',
//                 name: '*',
//                 actions: ['write'],
//                 publication: {
//                   actions: ['write'],
//                 },
//                 subscription: {
//                   actions: ['write'],
//                 },
//               },
//             ],
//             sfuBots: [
//               {
//                 actions: ['write'],
//                 forwardings: [
//                   {
//                     actions: ['write'],
//                   },
//                 ],
//               },
//             ],
//           },
//         ],
//       },
//     },
//   }).encode(secretKey);
  
//   (async () => {
    
//     // å®£è¨€ãƒ»åˆæœŸå€¤ã®ä»£å…¥
//     const localAudio = document.getElementById('local-audio');
//     const localVideo = document.getElementById('local-video');
//     const roomNameInput = document.getElementById('room-name');
//     const joinButton = document.getElementById('join-button');
//     const localMuteButton = document.getElementById('local-mute-buton');
//     const leaveButton = document.getElementById('leave-button');
//     const myId = document.getElementById('my-id');
//     const remoteId = document.getElementById('remote-id');
//     const remoteVideo = document.getElementById('remote-video');
//     const remoteAudio = document.getElementById('remote-audio');
//     const buttonArea = document.querySelector('#button-area');
//     const maxNumberParticipants = 2;
//     let isJoined = false;
//     let isMuted = false;
//     let selectBox = null;
//     leaveButton.disabled = true;
    
//     // STEP2: è‡ªåˆ†è‡ªèº«ã®ã‚«ãƒ¡ãƒ©ã¨ãƒã‚¤ã‚¯ã‚’å–å¾—ã—ã¦æç”»
//     const { audio, video } = await SkyWayStreamFactory.createMicrophoneAudioAndCameraStream();
//     audio.attach(localAudio);
//     video.attach(localVideo);
  

//   // Roomä½œæˆ/å‚åŠ ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
//   joinButton.onclick = async () => {
  
//     // RoomåãŒç©ºç™½ã®å ´åˆã¯å‡¦ç†çµ‚äº†
//     if (roomNameInput.value === '') return;

//     // STEP3: SFURoomã®ä½œæˆï¼ˆã™ã§ã«ä½œæˆä¸­ã®å ´åˆã¯ãã®æƒ…å ±ã‚’å–å¾—ï¼‰
//     // ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ã¨ã€ç”»åƒãƒ»éŸ³å£°å…¥æ‰‹ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒå‡ºãŸï¼ˆå±ãªã„ã®ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™è¦ã¨ã®ã“ã¨ï¼‰
//     const context = await SkyWayContext.Create(token);
//     const room = await SkyWayRoom.FindOrCreate(context, {
//       type: 'sfu',
//       name: roomNameInput.value,
//     });


//     // ã‚¢ãƒ—ãƒªä»•æ§˜ä¸Šã€Roomã®æœ€å¤§å‚åŠ äººæ•°ã‚’2åã«åˆ¶é™ã™ã‚‹
//     if (room.members.length > maxNumberParticipants){
//       console.log('æœ€å¤§å‚åŠ äººæ•°(' + maxNumberParticipants +')ã‚’è¶…ãˆã¦ã„ã¾ã™');
//       room.dispose();
//       return;
//     }
    
//     // STEP4: Roomã«å‚åŠ ã—è‡ªåˆ†ã®IDã‚’ç”»é¢ã«è¡¨ç¤º
//     let me = await room.join();
//     myId.textContent = me.id;
    
//     // UIã®åˆæœŸåŒ–
//     isJoinedã€€= true;
//     localMuteButton.disabled = false;
//     leaveButton.disabled = false;
    
//     // STEP5: è‡ªåˆ†ã®éŸ³å£°ã¨æ˜ åƒã‚’publishã™ã‚‹
//     const localAudioPublication = await me.publish(audio);
//     const localVideoPublication = await me.publish(video, {
//       encodings: [
//         { maxBitrate: 80_000, id: 'low' },
//         { maxBitrate: 500_000, id: 'middle' },
//         { maxBitrate: 5000_000, id: 'high' },
//       ],
//     });

//     // æ˜ åƒã¯ã‚µã‚¤ãƒãƒ«ã‚­ãƒ£ã‚¹ãƒˆã§3ãƒ‘ã‚¿ãƒ¼ãƒ³æŒ‡å®šã™ã‚‹

//     // STEP6: éŸ³å£°ãƒ»æ˜ åƒã®å—ä¿¡å‡¦ç†
//     // STEP6-1: éŸ³å£°ãƒ»æ˜ åƒã‚’subscribeã—ãŸæ™‚ã®å‡¦ç†
//     const subscribeAndAttach = (publication) => {
//         // è‡ªåˆ†ã®éŸ³å£°ãƒ»æ˜ åƒã ã£ãŸå ´åˆã¯å‡¦ç†ã‚’çµ‚äº†
//         if (publication.publisher.id === me.id) return;
  
//         // ç›¸æ‰‹ã®IDã‚’è¡¨ç¤º
//         remoteId.textContent = publication.publisher.id;
  
//         // éŸ³å£°ãƒ»æ˜ åƒã®å—ä¿¡ãŠã‚ˆã³å†ç”Ÿç”¨ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
//         if(buttonArea.childElementCount === 3) buttonArea.innerHTML='';
//         const subscribeButton = document.createElement('button');
//         subscribeButton.textContent = publication.contentType;
//         buttonArea.appendChild(subscribeButton);
        
//         // ã‚µã‚¤ãƒãƒ«ã‚­ãƒ£ã‚¹ãƒˆã®è§£åƒåº¦é¸æŠç”¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
//         if(publication.contentType === 'video'){
//           const selectData = [
//             { value: 'low', label: 'ä½ç”»è³ª' },
//             { value: 'middle', label: 'ä¸­ç”»è³ª' },
//             { value: 'high', label: 'é«˜ç”»è³ª' }
//           ];
//           selectBox = document.createElement('select');
//           for (let i = 0; i < selectData.length; i++) {
//             let option = document.createElement('option');
//             option.value = selectData[i].value;
//             option.text = selectData[i].label;
//             selectBox.appendChild(option);
//           }
//           buttonArea.appendChild(selectBox);
//         }
        
//         // å–å¾—ã—ãŸéŸ³å£°ãƒ»æ˜ åƒã‚’å—ä¿¡
//         subscribeButton.onclick = async () => {
//           const { stream, subscription } = await me.subscribe(publication.id);   
//           switch (stream.track.kind) {
//             case 'video':
//               stream.attach(remoteVideo);
//               // ã‚µã‚¤ãƒãƒ«ã‚­ãƒ£ã‚¹ã«ã‚ˆã‚‹æ˜ åƒã®é¸æŠ
//               subscription.changePreferredEncoding('low');
//               selectBox.addEventListener('change', function(){
//                 switch(this.value) {
//                   case 'low':
//                     subscription.changePreferredEncoding('low');
//                     break;
//                   case 'middle':
//                     subscription.changePreferredEncoding('middle');
//                     break;
//                   case 'high':
//                     subscription.changePreferredEncoding('high');
//                     break;
//                   default:
//                     return;
//                 }
//               });
  
//               // STEP7-2: æ˜ åƒãƒ»éŸ³å£°OFFãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†(å—ä¿¡å´ã®å‡¦ç†)

//               publication.onDisabled.add(() => remoteVideo.load());

  
//               break;
//             case 'audio':
//               stream.attach(remoteAudio);
//               break;
//             default:
//               return;
//           }
//           subscribeButton.disabled = true;
//         }
//       }
  

//     // STEP6-2: Roomå…¥å®¤æ™‚ã€ã™ã§ã«publishã•ã‚Œã¦ã„ã‚‹éŸ³å£°ãƒ»æ˜ åƒã‚’å—ä¿¡ã™ã‚‹ãŸã‚ã®å‡¦ç†
//     room.publications.forEach(subscribeAndAttach);

    
//     // STEP6-3: Roomå…¥å®¤å¾Œã«ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ã‚ˆã£ã¦publishã•ã‚ŒãŸéŸ³å£°ãƒ»æ˜ åƒã‚’å—ä¿¡ã™ã‚‹ãŸã‚ã®å‡¦ç†
//     room.onStreamPublished.add((e) => subscribeAndAttach(e.publication));

    
//     // STEP7: æ˜ åƒãƒ»éŸ³å£°OFFãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
//     // STEP7-1: æ˜ åƒãƒ»éŸ³å£°OFFãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†(é€ä¿¡å´ã®å‡¦ç†)
//     localMuteButton.onclick = async () => {
//         if(isMuted){
//           await localAudioPublication.enable();
//           await localVideoPublication.enable();
//           isMuted = false;
//           localMuteButton.textContent = 'æ˜ åƒãƒ»éŸ³å£°OFF';
//         }else{
//           await localAudioPublication.disable();
//           await localVideoPublication.disable();
//           isMuted = true;
//           localMuteButton.textContent = 'æ˜ åƒãƒ»éŸ³å£° ON';
//         }
//       }
  
    
//     // STEP8: Roomã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
//     leaveButton.onclick = async () => {
//         await me.leave();
//         await room.close();
//         closeRoom();
//         return;
//       }
  
//       // RoomãŒé–‰ã˜ã‚‰ã‚ŒãŸéš›ã®UIå‡¦ç†
//       const closeRoom = () => {
//         buttonArea.innerHTML = '';
//         remoteId.textContent = '';
//         myId.textContent = '';
//         localMuteButton.disabled = true;
//         leaveButton.disabled = true;
//       };
    
//       // Roomã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼ãŒæŠœã‘ãŸæ™‚ã®å‡¦ç†
//       room.onMemberLeft.add(() => closeRoom())

//   }
  
// })();
// // ä»¥ä¸ŠãŒãƒ“ãƒ‡ã‚ªç”¨ã®ã“ãƒ¼ã©

    //   Web Speech APIã‚’ä½¿ç”¨ã—ã¦éŸ³å£°ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
      function startSpeechRecognition() {
            const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
            recognition.lang = 'ja-JP'; // è¨€èªã‚’æ—¥æœ¬èªã«è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
            recognition.continuous = true; // é€£ç¶šã—ã¦éŸ³å£°ã‚’èªè­˜
            recognition.interimResults = false; // æš«å®šçµæœã‚’è¡¨ç¤ºã—ãªã„

            recognition.onresult = function(event) {
                const lastResultIndex = event.results.length - 1;
                const transcript = event.results[lastResultIndex][0].transcript.trim();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                push(questionsRef, {
                    question: 'éŸ³å£°',
                    answer: transcript,
                    timestamp: new Date().toISOString()
                });
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
            };

            recognition.onend = function() {
                console.log('Speech recognition ended');
                recognition.start(); // è‡ªå‹•çš„ã«å†ã‚¹ã‚¿ãƒ¼ãƒˆ
            };

            recognition.start();
        };

    $(document).ready(function() {
        // å­—å¹•ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºæ©Ÿèƒ½
        $('#hide-subtitles').click(function() {
            $('#subtitles').hide();
        });
    
        $('#show-subtitles').click(function() {
            $('#subtitles').show();
        });
    
        // å­—å¹•ã‚’å…¨ã¦å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½
        $('#clear-subtitles').click(function() {
            $('#subtitles').empty();
        });
    
        // å›ç­”ã‚’å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½
        $('#delete-answer').click(function() {
            $('#response').empty();
        });
    
        // è³ªå•ã‚’é€ä¿¡ã™ã‚‹
        $('#send-question').click(async function() {
            const question = $('#question-input').val().trim();
            if (question) {
                $('#response').text('AIãŒå›ç­”ã‚’ç”Ÿæˆä¸­ã§ã™...');
    
                // ChatGPT APIã‚’ä½¿ç”¨ã—ã¦å›ç­”ã‚’å–å¾—
                const aiResponse = await getAIResponse(question);
    
                // å›ç­”æ¬„ã«ã®ã¿è³ªå•ã¨å›ç­”ã‚’è¡¨ç¤º
                $('#response').html('<div><strong>è³ªå•:</strong> ' + escapeHtml(question) + '<br><strong>å›ç­”:</strong> ' + escapeHtml(aiResponse) + '</div>');
    
                // Firebaseã«è³ªå•ã¨å›ç­”ã‚’ä¿å­˜
                push(questionsRef, { question: question, answer: aiResponse });
                
                // è³ªå•å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
                $('#question-input').val('');
            }
        });
    
        // Enterã‚­ãƒ¼ã§é€ä¿¡
        $('#question-input').keypress(function(e) {
            if (e.which === 13) { // Enterã‚­ãƒ¼
                $('#send-question').click();
            }
        });
    
             // å›ç­”å‰Šé™¤ãƒœã‚¿ãƒ³
            $('#delete-response').click(function() {
            $('#response').text(''); // å›ç­”ã‚’å‰Šé™¤
            });

            // å­—å¹•éè¡¨ç¤ºãƒœã‚¿ãƒ³
            $('#hide-subtitles').click(function() {
            $('#subtitles').hide();
            });

            // å­—å¹•è¡¨ç¤ºãƒœã‚¿ãƒ³
            $('#show-subtitles').click(function() {
            $('#subtitles').show();
            });


            // Enterã‚­ãƒ¼ã§é€ä¿¡
            $('#question-input').keypress(function(e) {
                if (e.which === 13) { // Enterã‚­ãƒ¼
                    $('#send-question').click();
                }
            });

            // AIã®å¿œç­”ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            async function getAIResponse(question) {
                const apiKey = '::::::::::::::::::::::::::'; // OpenAIã®APIã‚­ãƒ¼ã‚’è¨­å®š
                const apiUrl = 'https://api.openai.com/v1/chat/completions';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4',
                            messages: [{ role: 'user', content: question }]
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        return data.choices[0].message.content.trim();
                    } else {
                        console.error('Error:', data);
                        return 'AIã‹ã‚‰ã®å›ç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
                    }
                } catch (error) {
                    console.error('Fetch Error:', error);
                    return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                }
            }

            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆXSSå¯¾ç­–ï¼‰
            function escapeHtml(text) {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        });

</script>
  
</body>
</html>